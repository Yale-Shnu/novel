<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斗破苍穹 - 小说智阅坊</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#64748b',
                        tertiary: '#059669',
                        success: '#10b981',
                        danger: '#ef4444',
                        info: '#3b82f6',
                        'text-primary': '#1e293b',
                        'text-secondary': '#64748b',
                        'bg-light': '#f8fafc',
                        'border-light': '#e2e8f0'
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'reader': '0 8px 32px rgba(0, 0, 0, 0.12)'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-collapsed {
            width: 56px;
        }
        
        .sidebar-expanded {
            width: 240px;
        }
        
        .main-content-expanded {
            margin-left: 240px;
        }
        
        .main-content-collapsed {
            margin-left: 56px;
        }
        
        .reader-content {
            line-height: 1.8;
            font-size: 16px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .reader-toolbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .nav-item-active {
            background-color: #dbeafe;
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }
        
        .nav-item:hover {
            background-color: #f1f5f9;
            color: #2563eb;
        }
        
        .search-focus:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .chapter-item:hover {
            background-color: #f8fafc;
            cursor: pointer;
        }
        
        .chapter-current {
            background-color: #dbeafe;
            color: #2563eb;
            font-weight: 600;
        }
        
        .analysis-sidebar {
            background: white;
            border-left: 1px solid #e2e8f0;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .analysis-tab {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .analysis-tab.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        
        .reading-progress {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
            z-index: 45;
            transition: width 0.3s ease;
        }
        
        .text-selection {
            background-color: rgba(37, 99, 235, 0.2);
        }
        
        .floating-toolbar {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 50;
            padding: 8px;
            display: none;
        }
        
        .floating-toolbar button {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            background: #f1f5f9;
            color: #334155;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .floating-toolbar button:hover {
            background: #e2e8f0;
        }
        
        .floating-toolbar button.primary {
            background: #2563eb;
            color: white;
        }
        
        .floating-toolbar button.primary:hover {
            background: #1d4ed8;
        }
        
        .setting-panel {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .setting-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            margin: 0 auto;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* 主题样式 */
        .theme-light {
            background-color: #ffffff;
            color: #1e293b;
        }
        
        .theme-dark {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        
        .theme-dark #reading-content {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        
        .theme-eye {
            background-color: #f0f9ff;
            color: #1e293b;
        }
        
        .theme-eye #reading-content {
            background-color: #f0f9ff;
            color: #1e293b;
        }
        
        .theme-custom {
            background-color: #fefce8;
            color: #1e293b;
        }
        
        .theme-custom #reading-content {
            background-color: #fefce8;
            color: #1e293b;
        }
        
        /* 高亮文本样式 */
        .text-highlight {
            background-color: #ffeb3b !important;
            padding: 2px 0 !important;
            border-radius: 2px !important;
            transition: background-color 0.2s ease;
        }
        
        .text-highlight:hover {
            background-color: #fdd835 !important;
        }
    </style>
</head>
<body class="bg-bg-light min-h-screen">
    <!-- 阅读进度条 -->
    <div id="reading-progress" class="reading-progress" style="width: 35%;"></div>

    <!-- 顶部导航栏 -->
    <header id="top-navbar" class="fixed top-0 left-0 right-0 bg-white border-b border-border-light h-16 z-50">
        <div class="flex items-center justify-between h-full px-6">
            <!-- 左侧：返回按钮和小说标题 -->
            <div class="flex items-center space-x-4">
                <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-100 lg:hidden">
                    <i class="fas fa-bars text-gray-600"></i>
                </button>
                <button id="back-to-shelf" class="flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100">
                    <i class="fas fa-arrow-left text-gray-600"></i>
                    <span class="hidden sm:block text-text-primary">返回书架</span>
                </button>
                <div class="flex items-center space-x-3">
                    <img src="https://s.coze.cn/image/oofkvJpkyX0/" 
                         alt="斗破苍穹封面" class="w-8 h-10 rounded object-cover" data-category="商业科技">
                    <div>
                        <h1 class="text-lg font-bold text-text-primary">斗破苍穹</h1>
                        <p class="text-sm text-text-secondary">天蚕土豆</p>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：搜索、用户 -->
            <div class="flex items-center space-x-4">
                <div class="relative hidden sm:block">
                    <input type="text" id="reader-search" placeholder="搜索本章内容..." 
                           class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg search-focus">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <button id="user-menu" class="flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                    <img src="https://s.coze.cn/image/U0VLUxOrDeM/" 
                         alt="用户头像" class="w-8 h-8 rounded-full" data-category="人物">
                    <span class="hidden md:block text-text-primary">读者</span>
                    <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 左侧菜单 -->
    <aside id="sidebar" class="fixed left-0 top-16 bottom-0 bg-white border-r border-border-light sidebar-expanded z-40 transition-all duration-300">
        <nav class="p-4 space-y-2">
            <a href="P-HOME.html" id="nav-home" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-text-secondary">
                <i class="fas fa-home w-5"></i>
                <span class="sidebar-text">首页</span>
            </a>
            <a href="P-SHELF.html" id="nav-shelf" class="nav-item nav-item-active flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium">
                <i class="fas fa-bookmark w-5"></i>
                <span class="sidebar-text">我的书架</span>
            </a>
            <a href="P-RECOMMEND.html" id="nav-recommend" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-text-secondary">
                <i class="fas fa-star w-5"></i>
                <span class="sidebar-text">为你推荐</span>
            </a>
            <a href="P-USER_CENTER.html" id="nav-user" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-text-secondary">
                <i class="fas fa-user w-5"></i>
                <span class="sidebar-text">用户中心</span>
            </a>
            <a href="P-HELP.html" id="nav-help" class="nav-item flex items-center space-x-3 px-4 py-3 rounded-lg text-sm font-medium text-text-secondary">
                <i class="fas fa-question-circle w-5"></i>
                <span class="sidebar-text">帮助中心</span>
            </a>
        </nav>
    </aside>

    <!-- 主内容区 -->
    <main id="main-content" class="main-content-expanded pt-16 min-h-screen transition-all duration-300">
        <div class="flex">
            <!-- 阅读区域 -->
            <div id="reading-area" class="flex-1 min-w-0">
                <!-- 阅读器工具栏 -->
                <div id="reader-toolbar" class="reader-toolbar fixed top-16 left-0 right-0 z-45">
                    <div class="flex items-center justify-between px-6 py-3">
                        <div class="flex items-center space-x-4">
                            <button id="chapter-prev" class="flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100">
                                <i class="fas fa-chevron-left text-gray-600"></i>
                                <span class="text-sm text-text-primary">上一章</span>
                            </button>
                            <div class="text-sm text-text-secondary">
                                第1章：陨落的天才
                            </div>
                            <button id="chapter-next" class="flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100">
                                <span class="text-sm text-text-primary">下一章</span>
                                <i class="fas fa-chevron-right text-gray-600"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <button id="toc-btn" class="p-2 rounded-lg hover:bg-gray-100" title="目录">
                                <i class="fas fa-list text-gray-600"></i>
                            </button>
                            <button id="search-btn" class="p-2 rounded-lg hover:bg-gray-100" title="搜索">
                                <i class="fas fa-search text-gray-600"></i>
                            </button>
                            <button id="analysis-btn" class="p-2 rounded-lg hover:bg-gray-100" title="智能解析">
                                <i class="fas fa-brain text-gray-600"></i>
                            </button>
                            <button id="settings-btn" class="p-2 rounded-lg hover:bg-gray-100" title="设置">
                                <i class="fas fa-cog text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 阅读内容 -->
                <div id="reading-content" class="reader-content p-8 pt-24">
                    <div class="text-text-primary leading-relaxed">
                        <p class="mb-6">
                            萧炎，萧家历史上空前绝后的斗气修炼天才。
                        </p>
                        <p class="mb-6">
                            年仅十一岁便成功凝聚斗之气旋，一跃成为家族百年之内最年轻的斗者！
                        </p>
                        <p class="mb-6">
                            然而天才的道路，似乎总是曲折的。三年之前，这个名声响彻整个乌坦城的天才少年，却是突兀的接二连三的在斗之气等级上倒退。
                        </p>
                        <p class="mb-6">
                            从九段斗之气，一路狂退到三段斗之气，并且这一退，便是整整三年时间，无论萧炎如何努力，他的斗之气，都始终停留在三段斗之气的水平，再也没有寸进。
                        </p>
                        <p class="mb-6">
                            天才之名，逐渐被“废物”二字所取代。
                        </p>
                        <p class="mb-6">
                            此刻，在萧家后山，一处偏僻的悬崖边，少年正盘膝而坐，清秀的小脸上，带着一丝与年龄不符的平静。
                        </p>
                        <p class="mb-6">
                            他的面前，悬浮着一枚通体漆黑的古朴戒指，戒指之上，隐隐有着奇异的纹路在流转。
                        </p>
                        <p class="mb-6">
                            这枚戒指，是萧炎在三年前，偶然从一个神秘老人那里得到的。
                        </p>
                        <p class="mb-6">
                            自从得到这枚戒指之后，他的斗气便开始莫名其妙的倒退。
                        </p>
                        <p class="mb-6">
                            “唉……”
                        </p>
                        <p class="mb-6">
                            轻轻的叹息了一声，萧炎睁开了双眼，漆黑的眸子中，闪过一丝无奈与不甘。
                        </p>
                        <p class="mb-6">
                            “三年了，整整三年了……”
                        </p>
                        <p class="mb-6">
                            他低声喃喃，拳头不自觉的紧握了起来。
                        </p>
                        
                        <!-- 读者参与式阅读选择点 -->
                        <div id="interactive-choice-point" class="border-l-4 border-primary bg-blue-50 p-6 my-8 rounded-r-lg">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-lightbulb text-primary text-xl mr-3"></i>
                                <h3 class="text-lg font-semibold text-text-primary">读者参与式阅读</h3>
                            </div>
                            <p class="text-text-secondary mb-4">故事发展到了关键节点，请选择接下来的剧情走向：</p>
                            
                            <div class="space-y-3">
                                <button class="choice-btn w-full text-left p-4 bg-white border border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-all" data-choice="1">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center mr-3">A</span>
                                        <span>萧炎决定继续研究这枚神秘的戒指，试图找出斗气倒退的原因</span>
                                    </div>
                                </button>
                                
                                <button class="choice-btn w-full text-left p-4 bg-white border border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-all" data-choice="2">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center mr-3">B</span>
                                        <span>萧炎决定暂时放下戒指，先专注于提升自己的斗气修为</span>
                                    </div>
                                </button>
                                
                                <button class="choice-btn w-full text-left p-4 bg-white border border-gray-200 rounded-lg hover:border-primary hover:bg-blue-50 transition-all" data-choice="custom">
                                    <div class="flex items-center">
                                        <span class="w-6 h-6 bg-primary text-white rounded-full flex items-center justify-center mr-3">C</span>
                                        <span>自定义剧情走向（输入你的想法）</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        <p class="mb-6">
                            就在这时，那枚悬浮在他面前的黑色戒指，突然微微一颤，一道细微的光芒，从戒指内部一闪而逝。
                        </p>
                        <p class="mb-6">
                            萧炎心中一动，目光紧紧的盯着那枚戒指。
                        </p>
                        <p class="mb-6">
                            三年来，这枚戒指除了偶尔会吸收他的斗气之外，从未有过任何异常。
                        </p>
                        <p class="mb-6">
                            而现在，它竟然……
                        </p>
                    </div>
                </div>
            </div>

            <!-- 智能解析侧边栏 -->
            <aside id="analysis-sidebar" class="analysis-sidebar w-80 fixed right-0 top-16 bottom-0 z-40 transform translate-x-full transition-transform duration-300">
                <div class="p-4">
                    <!-- 智能解析标签页 -->
                    <div class="flex space-x-6 border-b border-border-light mb-4">
                        <button id="tab-outline" class="analysis-tab active py-3 text-sm font-medium">大纲总结</button>
                        <button id="tab-character" class="analysis-tab py-3 text-sm font-medium text-text-secondary">角色图谱</button>
                        <button id="tab-setting" class="analysis-tab py-3 text-sm font-medium text-text-secondary">设定集</button>
                        <button id="tab-semantic" class="analysis-tab py-3 text-sm font-medium text-text-secondary">语义网络</button>
                    </div>
                    
                    <!-- 大纲总结内容 -->
                    <div id="content-outline" class="analysis-content">
                        <h3 class="text-lg font-semibold text-text-primary mb-4">本章大纲</h3>
                        <div class="space-y-3">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">核心情节</h4>
                                <p class="text-sm text-text-secondary mt-1">萧炎从天才跌落为废物的背景介绍，以及神秘戒指的异常反应</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">关键转折点</h4>
                                <p class="text-sm text-text-secondary mt-1">黑色戒指出现异常光芒，暗示故事即将发生变化</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">人物状态</h4>
                                <p class="text-sm text-text-secondary mt-1">萧炎内心充满不甘但依然保持冷静，对未来仍有期待</p>
                            </div>
                        </div>
                        <button id="view-full-outline" class="w-full mt-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                            查看完整大纲
                        </button>
                    </div>
                    
                    <!-- 角色图谱内容 -->
                    <div id="content-character" class="analysis-content hidden">
                        <h3 class="text-lg font-semibold text-text-primary mb-4">主要角色</h3>
                        <div class="space-y-3">
                            <div class="border border-border-light rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">萧炎</h4>
                                <p class="text-sm text-text-secondary mt-1">本书主角，曾经的修炼天才，因神秘戒指而斗气倒退</p>
                                <div class="flex space-x-2 mt-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-blue-100 text-blue-800">主角</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">萧家</span>
                                </div>
                            </div>
                        </div>
                        <button id="view-full-character" class="w-full mt-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                            查看完整角色图谱
                        </button>
                    </div>
                    
                    <!-- 设定集内容 -->
                    <div id="content-setting" class="analysis-content hidden">
                        <h3 class="text-lg font-semibold text-text-primary mb-4">世界观设定</h3>
                        <div class="space-y-3">
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">斗气体系</h4>
                                <p class="text-sm text-text-secondary mt-1">修炼体系的基础，从斗之气到斗帝，共分十个大境界</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">乌坦城</h4>
                                <p class="text-sm text-text-secondary mt-1">故事开始的地点，萧家所在地</p>
                            </div>
                        </div>
                        <button id="view-full-setting" class="w-full mt-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                            查看完整设定集
                        </button>
                    </div>
                    
                    <!-- 语义网络内容 -->
                    <div id="content-semantic" class="analysis-content hidden">
                        <h3 class="text-lg font-semibold text-text-primary mb-4">概念关联</h3>
                        <div class="space-y-3">
                            <div class="border border-border-light rounded-lg p-3">
                                <h4 class="font-medium text-text-primary">核心概念</h4>
                                <div class="flex flex-wrap gap-2 mt-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-purple-100 text-purple-800">斗气</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800">修炼</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-pink-100 text-pink-800">戒指</span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-indigo-100 text-indigo-800">天才</span>
                                </div>
                            </div>
                        </div>
                        <button id="view-full-semantic" class="w-full mt-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition-colors">
                            查看完整语义网络
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- 目录抽屉 -->
    <div id="toc-drawer" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute left-0 top-0 bottom-0 w-96 bg-white shadow-xl transform -translate-x-full transition-transform duration-300">
            <div class="p-4 border-b border-border-light">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-text-primary">章节目录</h3>
                    <button id="toc-close" class="p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
            </div>
            <div class="overflow-y-auto h-full pb-4">
                <div class="p-4 space-y-1">
                    <div class="chapter-item chapter-current px-3 py-2 rounded-lg text-sm">
                        <i class="fas fa-bookmark text-primary mr-2"></i>
                        第1章：陨落的天才
                    </div>
                    <div class="chapter-item px-3 py-2 rounded-lg text-sm text-text-secondary">
                        第2章：萧家
                        <span class="text-xs text-gray-400 ml-2">(未读)</span>
                    </div>
                    <div class="chapter-item px-3 py-2 rounded-lg text-sm text-text-secondary">
                        第3章：斗之气
                        <span class="text-xs text-gray-400 ml-2">(未读)</span>
                    </div>
                    <div class="chapter-item px-3 py-2 rounded-lg text-sm text-text-secondary">
                        第4章：神秘来客
                        <span class="text-xs text-gray-400 ml-2">(未读)</span>
                    </div>
                    <div class="chapter-item px-3 py-2 rounded-lg text-sm text-text-secondary">
                        第5章：药老
                        <span class="text-xs text-gray-400 ml-2">(未读)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 浮动工具栏 -->
    <div id="floating-toolbar" class="floating-toolbar">
        <div class="flex space-x-2">
            <button id="highlight-btn" class="primary" title="高亮">
                <i class="fas fa-highlighter"></i>
            </button>
            <button id="note-btn" title="添加笔记">
                <i class="fas fa-sticky-note"></i>
            </button>
            <button id="comic-btn" title="生成四格漫画">
                <i class="fas fa-image"></i>
            </button>
            <button id="annotation-btn" title="智能批注">
                <i class="fas fa-comment"></i>
            </button>
        </div>
    </div>

    <!-- 阅读设置弹窗 -->
    <div id="settings-modal" class="fixed inset-0 setting-panel z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="setting-content w-full max-w-md">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-text-primary">阅读设置</h3>
                        <button id="settings-close" class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-times text-gray-600"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- 字体设置 -->
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-3">字体</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button class="font-setting-btn active px-3 py-2 rounded-lg border border-primary bg-primary text-white text-sm">宋体</button>
                                <button class="font-setting-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">黑体</button>
                                <button class="font-setting-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">楷体</button>
                            </div>
                        </div>
                        
                        <!-- 字体大小 -->
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-3">字体大小</label>
                            <div class="flex items-center space-x-4">
                                <button id="font-size-sm" class="px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">小</button>
                                <button id="font-size-md" class="px-3 py-2 rounded-lg border border-primary bg-primary text-white text-sm">中</button>
                                <button id="font-size-lg" class="px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-lg">大</button>
                                <button id="font-size-xl" class="px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-xl">特大</button>
                            </div>
                        </div>
                        
                        <!-- 行间距 -->
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-3">行间距</label>
                            <div class="grid grid-cols-3 gap-3">
                                <button class="line-height-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">紧凑</button>
                                <button class="line-height-btn active px-3 py-2 rounded-lg border border-primary bg-primary text-white text-sm">标准</button>
                                <button class="line-height-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">宽松</button>
                            </div>
                        </div>
                        
                        <!-- 主题模式 -->
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-3">主题模式</label>
                            <div class="grid grid-cols-2 gap-3">
                                <button id="theme-light" class="theme-btn active px-3 py-2 rounded-lg border border-primary bg-primary text-white text-sm">日间模式</button>
                                <button id="theme-dark" class="theme-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">夜间模式</button>
                                <button id="theme-eye" class="theme-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">护眼模式</button>
                                <button id="theme-custom" class="theme-btn px-3 py-2 rounded-lg border border-gray-300 hover:border-primary text-sm">自定义</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入API配置 -->
    <script src="api-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 解析URL参数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const urlParams = new URLSearchParams(queryString);
                
                for(const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // 获取URL参数
            const params = getUrlParams();
            const novelId = params.novel || 'doupocangqiong';
            
            // 侧边栏切换功能
            const sidebarToggle = document.querySelector('#sidebar-toggle');
            const sidebar = document.querySelector('#sidebar');
            const mainContent = document.querySelector('#main-content');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            
            let sidebarCollapsed = false;
            
            sidebarToggle.addEventListener('click', () => {
                sidebarCollapsed = !sidebarCollapsed;
                
                if (sidebarCollapsed) {
                    sidebar.classList.remove('sidebar-expanded');
                    sidebar.classList.add('sidebar-collapsed');
                    mainContent.classList.remove('main-content-expanded');
                    mainContent.classList.add('main-content-collapsed');
                    sidebarTexts.forEach(text => text.style.display = 'none');
                } else {
                    sidebar.classList.remove('sidebar-collapsed');
                    sidebar.classList.add('sidebar-expanded');
                    mainContent.classList.remove('main-content-collapsed');
                    mainContent.classList.add('main-content-expanded');
                    sidebarTexts.forEach(text => text.style.display = 'block');
                }
            });

            // 返回书架
            document.querySelector('#back-to-shelf').addEventListener('click', function() {
                window.location.href = 'P-SHELF.html';
            });

            // 章节导航
            document.querySelector('#chapter-prev').addEventListener('click', function() {
                console.log('跳转到上一章');
                // 实际应用中这里会加载上一章内容
            });

            document.querySelector('#chapter-next').addEventListener('click', function() {
                console.log('跳转到下一章');
                // 实际应用中这里会加载下一章内容
            });

            // 目录抽屉
            const tocDrawer = document.querySelector('#toc-drawer');
            const tocBtn = document.querySelector('#toc-btn');
            const tocClose = document.querySelector('#toc-close');

            tocBtn.addEventListener('click', function() {
                tocDrawer.classList.remove('hidden');
                setTimeout(() => {
                    tocDrawer.querySelector('.transform').classList.remove('-translate-x-full');
                }, 10);
            });

            tocClose.addEventListener('click', function() {
                tocDrawer.querySelector('.transform').classList.add('-translate-x-full');
                setTimeout(() => {
                    tocDrawer.classList.add('hidden');
                }, 300);
            });

            // 点击背景关闭目录
            tocDrawer.addEventListener('click', function(e) {
                if (e.target === tocDrawer) {
                    tocClose.click();
                }
            });

            // 章节点击事件
            document.querySelectorAll('.chapter-item').forEach(item => {
                item.addEventListener('click', function() {
                    // 移除所有章节的当前状态
                    document.querySelectorAll('.chapter-item').forEach(chapter => {
                        chapter.classList.remove('chapter-current');
                        chapter.classList.add('text-text-secondary');
                    });
                    
                    // 设置当前章节
                    this.classList.add('chapter-current');
                    this.classList.remove('text-text-secondary');
                    
                    console.log('跳转到章节:', this.textContent.trim());
                    tocClose.click();
                });
            });

            // 智能解析侧边栏
            const analysisSidebar = document.querySelector('#analysis-sidebar');
            const analysisBtn = document.querySelector('#analysis-btn');

            analysisBtn.addEventListener('click', function() {
                if (analysisSidebar.classList.contains('translate-x-full')) {
                    analysisSidebar.classList.remove('translate-x-full');
                } else {
                    analysisSidebar.classList.add('translate-x-full');
                }
            });

            // 智能解析标签页切换
            const analysisTabs = document.querySelectorAll('.analysis-tab');
            const analysisContents = document.querySelectorAll('.analysis-content');

            analysisTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 移除所有标签页的active状态
                    analysisTabs.forEach(t => {
                        t.classList.remove('active');
                        t.classList.add('text-text-secondary');
                    });
                    
                    // 隐藏所有内容
                    analysisContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // 激活当前标签页
                    this.classList.add('active');
                    this.classList.remove('text-text-secondary');
                    
                    // 显示对应内容
                    const tabId = this.id.replace('tab-', 'content-');
                    document.querySelector(`#${tabId}`).classList.remove('hidden');
                });
            });

            // 查看完整解析页面
            document.querySelector('#view-full-outline').addEventListener('click', function() {
                window.location.href = `P-ANALYSIS_OUTLINE.html?novel=${novelId}`;
            });

            document.querySelector('#view-full-character').addEventListener('click', function() {
                window.location.href = `P-ANALYSIS_CHARACTER.html?novel=${novelId}`;
            });

            document.querySelector('#view-full-setting').addEventListener('click', function() {
                window.location.href = `P-ANALYSIS_SETTING.html?novel=${novelId}`;
            });

            document.querySelector('#view-full-semantic').addEventListener('click', function() {
                window.location.href = `P-ANALYSIS_SEMANTIC.html?novel=${novelId}`;
            });

            // 搜索功能
            document.querySelector('#reader-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const keyword = e.target.value.trim();
                    if (keyword) {
                        console.log('搜索内容:', keyword);
                        // 实际应用中这里会执行搜索
                    }
                }
            });

            document.querySelector('#search-btn').addEventListener('click', function() {
                document.querySelector('#reader-search').focus();
            });

            // 阅读设置弹窗
            const settingsModal = document.querySelector('#settings-modal');
            const settingsBtn = document.querySelector('#settings-btn');
            const settingsClose = document.querySelector('#settings-close');

            settingsBtn.addEventListener('click', function() {
                settingsModal.classList.remove('hidden');
            });

            settingsClose.addEventListener('click', function() {
                settingsModal.classList.add('hidden');
            });

            // 点击背景关闭设置弹窗
            settingsModal.addEventListener('click', function(e) {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });

            // 字体设置
            document.querySelectorAll('.font-setting-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.font-setting-btn').forEach(b => {
                        b.classList.remove('active', 'border-primary', 'bg-primary', 'text-white');
                        b.classList.add('border-gray-300');
                    });
                    
                    this.classList.add('active', 'border-primary', 'bg-primary', 'text-white');
                    this.classList.remove('border-gray-300');
                    
                    // 实际应用字体设置
                    const fontFamily = this.textContent;
                    const readingContent = document.querySelector('#reading-content');
                    
                    switch(fontFamily) {
                        case '宋体':
                            readingContent.style.fontFamily = 'SimSun, serif';
                            break;
                        case '黑体':
                            readingContent.style.fontFamily = 'SimHei, sans-serif';
                            break;
                        case '楷体':
                            readingContent.style.fontFamily = 'KaiTi, serif';
                            break;
                    }
                    
                    console.log('设置字体:', fontFamily);
                });
            });

            // 字体大小设置
            const fontSizeBtns = document.querySelectorAll('[id^="font-size-"]');
            fontSizeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    fontSizeBtns.forEach(b => {
                        b.classList.remove('border-primary', 'bg-primary', 'text-white');
                        b.classList.add('border-gray-300');
                    });
                    
                    this.classList.add('border-primary', 'bg-primary', 'text-white');
                    this.classList.remove('border-gray-300');
                    
                    // 实际应用字体大小设置
                    const fontSize = this.id.replace('font-size-', '');
                    const readingContent = document.querySelector('#reading-content');
                    
                    switch(fontSize) {
                        case 'sm':
                            readingContent.style.fontSize = '14px';
                            break;
                        case 'md':
                            readingContent.style.fontSize = '16px';
                            break;
                        case 'lg':
                            readingContent.style.fontSize = '18px';
                            break;
                        case 'xl':
                            readingContent.style.fontSize = '20px';
                            break;
                    }
                    
                    console.log('设置字体大小:', this.textContent);
                });
            });

            // 行间距设置
            document.querySelectorAll('.line-height-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.line-height-btn').forEach(b => {
                        b.classList.remove('active', 'border-primary', 'bg-primary', 'text-white');
                        b.classList.add('border-gray-300');
                    });
                    
                    this.classList.add('active', 'border-primary', 'bg-primary', 'text-white');
                    this.classList.remove('border-gray-300');
                    
                    // 实际应用行间距设置
                    const lineHeight = this.textContent;
                    const readingContent = document.querySelector('#reading-content');
                    
                    switch(lineHeight) {
                        case '紧凑':
                            readingContent.style.lineHeight = '1.4';
                            break;
                        case '标准':
                            readingContent.style.lineHeight = '1.8';
                            break;
                        case '宽松':
                            readingContent.style.lineHeight = '2.2';
                            break;
                    }
                    
                    console.log('设置行间距:', lineHeight);
                });
            });

            // 主题模式设置
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.classList.remove('active', 'border-primary', 'bg-primary', 'text-white');
                        b.classList.add('border-gray-300');
                    });
                    
                    this.classList.add('active', 'border-primary', 'bg-primary', 'text-white');
                    this.classList.remove('border-gray-300');
                    
                    // 实际应用主题设置
                    const theme = this.textContent;
                    const body = document.body;
                    const readingContent = document.querySelector('#reading-content');
                    
                    // 移除所有主题类
                    body.classList.remove('theme-light', 'theme-dark', 'theme-eye', 'theme-custom');
                    readingContent.classList.remove('theme-light', 'theme-dark', 'theme-eye', 'theme-custom');
                    
                    switch(theme) {
                        case '日间模式':
                            body.classList.add('theme-light');
                            readingContent.classList.add('theme-light');
                            break;
                        case '夜间模式':
                            body.classList.add('theme-dark');
                            readingContent.classList.add('theme-dark');
                            break;
                        case '护眼模式':
                            body.classList.add('theme-eye');
                            readingContent.classList.add('theme-eye');
                            break;
                        case '自定义':
                            body.classList.add('theme-custom');
                            readingContent.classList.add('theme-custom');
                            break;
                    }
                    
                    console.log('设置主题:', theme);
                });
            });

            // 浮动工具栏
            const floatingToolbar = document.querySelector('#floating-toolbar');
            let selectedText = '';

            // 监听文本选择
            document.addEventListener('mouseup', function(e) {
                // 如果点击的是浮动工具栏，不处理
                if (e.target.closest('#floating-toolbar')) {
                    return;
                }
                
                const selection = window.getSelection();
                selectedText = selection.toString().trim();
                
                if (selectedText && selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    
                    // 确保浮动工具栏不会超出屏幕边界
                    let left = rect.left + rect.width / 2 - 100;
                    let top = rect.top - 50;
                    
                    // 边界检查
                    if (left < 10) left = 10;
                    if (left > window.innerWidth - 220) left = window.innerWidth - 220;
                    if (top < 10) top = 10;
                    
                    floatingToolbar.style.left = left + 'px';
                    floatingToolbar.style.top = top + 'px';
                    floatingToolbar.style.display = 'block';
                } else {
                    floatingToolbar.style.display = 'none';
                }
            });

            // 点击其他地方隐藏浮动工具栏
            document.addEventListener('click', function(e) {
                // 如果点击的是浮动工具栏本身，不隐藏
                if (floatingToolbar.contains(e.target)) {
                    return;
                }
                
                // 如果点击的是阅读内容区域，不隐藏
                if (e.target.closest('#reading-content')) {
                    return;
                }
                
                // 其他情况隐藏浮动工具栏
                floatingToolbar.style.display = 'none';
            });

            // 浮动工具栏按钮事件
            document.querySelector('#highlight-btn').addEventListener('click', function(e) {
                e.stopPropagation(); // 阻止事件冒泡
                e.preventDefault(); // 阻止默认行为
                
                if (!selectedText) return;
                
                console.log('高亮文本:', selectedText);
                
                // 实现高亮功能
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    
                    // 更可靠的高亮实现 - 优先使用现代方法
                    try {
                        // 方法1：使用CSS类的高亮实现（最可靠）
                        const highlightSpan = document.createElement('span');
                        highlightSpan.className = 'text-highlight';
                        highlightSpan.style.backgroundColor = '#ffeb3b';
                        highlightSpan.style.padding = '2px 0';
                        highlightSpan.style.borderRadius = '2px';
                        highlightSpan.style.display = 'inline';
                        highlightSpan.style.color = 'inherit';
                        
                        // 获取选中内容
                        const selectedContent = range.extractContents();
                        
                        // 将内容放入高亮span中
                        highlightSpan.appendChild(selectedContent);
                        
                        // 将高亮span插入到原来的位置
                        range.insertNode(highlightSpan);
                        
                        // 清除选区
                        selection.removeAllRanges();
                        
                        console.log('CSS类高亮成功');
                        showHighlightSuccess();
                        
                    } catch (error) {
                        console.error('CSS类高亮失败:', error);
                        
                        // 方法2：使用document.execCommand（兼容性方法）
                        try {
                            // 保存选区
                            const savedSelection = selection.getRangeAt(0);
                            
                            // 使用execCommand
                            if (document.queryCommandSupported('styleWithCSS')) {
                                document.execCommand('styleWithCSS', false, true);
                            }
                            
                            // 设置背景颜色
                            document.execCommand('hiliteColor', false, '#ffeb3b');
                            
                            // 清除选区
                            selection.removeAllRanges();
                            
                            console.log('execCommand高亮成功');
                            showHighlightSuccess();
                            
                        } catch (execError) {
                            console.error('execCommand高亮失败:', execError);
                            
                            // 方法3：使用mark标签（语义化高亮）
                            try {
                                const mark = document.createElement('mark');
                                mark.style.backgroundColor = '#ffeb3b';
                                mark.style.padding = '2px 0';
                                mark.style.borderRadius = '2px';
                                mark.style.display = 'inline';
                                
                                const selectedContent = range.extractContents();
                                mark.appendChild(selectedContent);
                                range.insertNode(mark);
                                selection.removeAllRanges();
                                
                                console.log('mark高亮成功');
                                showHighlightSuccess();
                                
                            } catch (markError) {
                                console.error('所有高亮方法都失败:', markError);
                                alert('高亮失败，请尝试选择更简单的文本段落');
                            }
                        }
                    }
                }
                
                floatingToolbar.style.display = 'none';
                selectedText = ''; // 清空选中文本
            });
            
            // 显示高亮成功提示
            function showHighlightSuccess() {
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                successMsg.innerHTML = '<i class="fas fa-check mr-2"></i>文本高亮成功！';
                successMsg.style.animation = 'fadeInOut 3s forwards';
                
                // 添加动画样式
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateX(100px); }
                        20% { opacity: 1; transform: translateX(0); }
                        80% { opacity: 1; transform: translateX(0); }
                        100% { opacity: 0; transform: translateX(100px); }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(successMsg);
                
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        document.body.removeChild(successMsg);
                    }
                }, 3000);
            }

            document.querySelector('#note-btn').addEventListener('click', function() {
                if (!selectedText) return;
                
                console.log('添加笔记:', selectedText);
                
                // 创建笔记弹窗
                const noteModal = document.createElement('div');
                noteModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
                noteModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-96">
                        <h3 class="text-lg font-semibold mb-4">添加笔记</h3>
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">选中的文本：</p>
                            <p class="bg-gray-100 p-2 rounded text-sm">${selectedText}</p>
                        </div>
                        <textarea class="w-full border border-gray-300 rounded p-2 mb-4" placeholder="请输入笔记内容..." rows="4"></textarea>
                        <div class="flex justify-end space-x-2">
                            <button class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">取消</button>
                            <button class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-600">保存</button>
                        </div>
                    </div>
                `;
                
                // 添加事件处理
                noteModal.querySelector('button:last-child').addEventListener('click', function() {
                    const noteContent = noteModal.querySelector('textarea').value;
                    if (noteContent.trim()) {
                        console.log('保存笔记:', noteContent);
                        alert('笔记保存成功！');
                    }
                    document.body.removeChild(noteModal);
                });
                
                noteModal.querySelector('button:first-child').addEventListener('click', function() {
                    document.body.removeChild(noteModal);
                });
                
                document.body.appendChild(noteModal);
                floatingToolbar.style.display = 'none';
            });

            document.querySelector('#comic-btn').addEventListener('click', function() {
                if (!selectedText) {
                    alert('请先选中要生成漫画的文本');
                    return;
                }
                
                console.log('生成四格漫画:', selectedText);
                floatingToolbar.style.display = 'none';
                
                // 显示加载状态
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>生成中...';
                this.disabled = true;
                
                // 延迟一下让用户看到加载状态，然后立即跳转
                setTimeout(() => {
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                    // 打开漫画查看器（新窗口）
                    const comicUrl = `P-COMIC_VIEWER_NEW.html?text=${encodeURIComponent(selectedText)}&novel=${novelId}`;
                    window.open(comicUrl, 'comicViewer', 'width=1200,height=800,resizable=yes,scrollbars=yes');
                }, 500);
            });

            document.querySelector('#annotation-btn').addEventListener('click', async function() {
                if (!selectedText) {
                    alert('请先选中要生成批注的文本');
                    return;
                }
                
                console.log('生成智能批注:', selectedText);
                floatingToolbar.style.display = 'none';
                
                // 检查API服务是否可用
                if (!window.apiService || !window.apiService.generateText) {
                    alert('API服务不可用，请确保服务器已启动。将直接打开批注页面，您可以在页面内重新生成批注。');
                    window.location.href = `P-ANNOTATION_VIEWER.html?text=${encodeURIComponent(selectedText)}&novel=${novelId}`;
                    return;
                }
                
                try {
                    // 显示加载状态
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>生成中...';
                    this.disabled = true;
                    
                    // 调用API生成智能批注
                    const annotation = await window.apiService.generateText(`请为以下小说片段提供智能批注和分析：
${selectedText}

请从以下角度进行分析：
1. 文学手法分析
2. 情节发展意义
3. 人物心理描写
4. 主题思想体现
5. 写作技巧评价

请用中文回答，分析要专业且有深度。`);
                    
                    // 恢复按钮状态
                    this.innerHTML = originalText;
                    this.disabled = false;
                    
                    // 使用sessionStorage存储数据，避免URL过长
                    sessionStorage.setItem('annotationText', selectedText);
                    sessionStorage.setItem('annotationResult', annotation);
                    sessionStorage.setItem('annotationNovelId', novelId);
                    
                    // 打开批注查看器
                    window.location.href = `P-ANNOTATION_VIEWER.html`;
                } catch (error) {
                    console.error('生成批注失败:', error);
                    alert('智能批注生成失败，将直接打开批注页面：' + error.message);
                    
                    // 恢复按钮状态
                    this.innerHTML = '<i class="fas fa-comment"></i>';
                    this.disabled = false;
                    
                    // 即使API失败也打开批注页面
                    sessionStorage.setItem('annotationText', selectedText);
                    sessionStorage.setItem('annotationNovelId', novelId);
                    window.location.href = `P-ANNOTATION_VIEWER.html`;
                }
            });

            // 阅读进度更新
            function updateReadingProgress() {
                const content = document.querySelector('#reading-content');
                const scrollTop = content.scrollTop;
                const scrollHeight = content.scrollHeight - content.clientHeight;
                const progress = (scrollTop / scrollHeight) * 100;
                
                document.querySelector('#reading-progress').style.width = progress + '%';
            }

            document.querySelector('#reading-content').addEventListener('scroll', updateReadingProgress);

            // 响应式处理
            function handleResize() {
                if (window.innerWidth < 1024) {
                    sidebar.style.transform = sidebarCollapsed ? 'translateX(0)' : 'translateX(0)';
                } else {
                    sidebar.style.transform = 'translateX(0)';
                }
                
                // 智能解析侧边栏响应式
                if (window.innerWidth < 1500) {
                    analysisSidebar.classList.add('translate-x-full');
                }
            }

            window.addEventListener('resize', handleResize);
            handleResize(); // 初始化
            
            // 读者参与式阅读功能
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const choice = this.getAttribute('data-choice');
                    const choicePoint = document.querySelector('#interactive-choice-point');
                    
                    // 显示加载状态
                    const originalHTML = choicePoint.innerHTML;
                    choicePoint.innerHTML = `
                        <div class="flex items-center justify-center py-8">
                            <i class="fas fa-spinner fa-spin text-primary text-xl mr-3"></i>
                            <span class="text-text-primary">AI正在生成后续剧情...</span>
                        </div>
                    `;
                    
                    try {
                        let prompt = '';
                        if (choice === 'custom') {
                            // 自定义选择 - 使用模态框获取用户输入
                            const customInput = await getCustomInput();
                            if (!customInput) {
                                choicePoint.innerHTML = originalHTML;
                                return;
                            }
                            
                            prompt = `基于以下小说情节和读者的自定义选择，生成简短的后续剧情：

当前情节：萧炎从天才跌落为废物，正在研究神秘戒指时发现戒指出现异常光芒。
读者选择：${customInput}

请生成简短（100-200字）的后续剧情，保持原作的风格和人物性格。`;
                        } else if (choice === '1') {
                            prompt = `基于以下小说情节和读者的选择，生成简短的后续剧情：

当前情节：萧炎从天才跌落为废物，正在研究神秘戒指时发现戒指出现异常光芒。
读者选择：萧炎决定继续研究这枚神秘的戒指，试图找出斗气倒退的原因

请生成简短（100-200字）的后续剧情，保持原作的风格和人物性格。`;
                        } else if (choice === '2') {
                            prompt = `基于以下小说情节和读者的选择，生成简短的后续剧情：

当前情节：萧炎从天才跌落为废物，正在研究神秘戒指时发现戒指出现异常光芒。
读者选择：萧炎决定暂时放下戒指，先专注于提升自己的斗气修为

请生成简短（100-200字）的后续剧情，保持原作的风格和人物性格。`;
                        }
                        
                        // 调用DeepSeek API生成后续剧情
                        const generatedText = await window.apiService.generateText(prompt, 300);
                        
                        // 显示生成的剧情
                        choicePoint.innerHTML = `
                            <div class="flex items-center mb-4">
                                <i class="fas fa-magic text-primary text-xl mr-3"></i>
                                <h3 class="text-lg font-semibold text-text-primary">AI生成剧情</h3>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-gray-200 mb-4">
                                <p class="text-text-primary leading-relaxed">${generatedText}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600" onclick="location.reload()">重新选择</button>
                                <button class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" onclick="document.querySelector('#interactive-choice-point').remove()">继续阅读</button>
                            </div>
                        `;
                        
                    } catch (error) {
                        console.error('生成剧情失败:', error);
                        choicePoint.innerHTML = `
                            <div class="text-center py-8">
                                <i class="fas fa-exclamation-triangle text-red-500 text-xl mb-2"></i>
                                <p class="text-text-primary">剧情生成失败，请重试</p>
                                <button class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600" onclick="location.reload()">重新选择</button>
                            </div>
                        `;
                    }
                });
            });
            
            // AI助读功能
            const aiAssistantBtn = document.querySelector('#ai-assistant-btn');
            const aiAssistantModal = document.querySelector('#ai-assistant-modal');
            const aiAssistantClose = document.querySelector('#ai-assistant-close');
            const aiChatInput = document.querySelector('#ai-chat-input');
            const aiChatSend = document.querySelector('#ai-chat-send');
            const aiChatMessages = document.querySelector('#ai-chat-messages');
            
            // 打开AI助读对话框
            aiAssistantBtn.addEventListener('click', function() {
                aiAssistantModal.classList.remove('hidden');
                setTimeout(() => {
                    aiAssistantModal.querySelector('.transform').classList.remove('translate-x-full');
                }, 10);
                aiChatInput.focus();
            });
            
            // 关闭AI助读对话框
            aiAssistantClose.addEventListener('click', function() {
                aiAssistantModal.querySelector('.transform').classList.add('translate-x-full');
                setTimeout(() => {
                    aiAssistantModal.classList.add('hidden');
                }, 300);
            });
            
            // 点击背景关闭对话框
            aiAssistantModal.addEventListener('click', function(e) {
                if (e.target === aiAssistantModal) {
                    aiAssistantClose.click();
                }
            });
            
            // 发送消息
            aiChatSend.addEventListener('click', sendAIMessage);
            aiChatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });
            
            // 快速问题按钮
            document.querySelectorAll('.quick-question-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const question = this.textContent;
                    aiChatInput.value = question;
                    sendAIMessage();
                });
            });
            
            async function sendAIMessage() {
                const message = aiChatInput.value.trim();
                if (!message) return;
                
                // 添加用户消息
                addMessage(message, 'user');
                aiChatInput.value = '';
                
                // 显示AI正在输入
                const thinkingMsg = addMessage('小樟同学正在思考...', 'ai', true);
                
                try {
                    // 获取当前阅读内容作为上下文
                    const currentContent = document.querySelector('#reading-content').textContent.substring(0, 500);
                    
                    const prompt = `你是一个小说阅读助手"小樟同学"，请基于以下小说内容回答用户的问题：

小说内容：${currentContent}

用户问题：${message}

请用友好、专业的语气回答，帮助用户更好地理解小说内容。回答要简洁明了，控制在200字以内。`;
                    
                    const response = await window.apiService.generateText(prompt, 300);
                    
                    // 移除"正在思考"消息，添加真实回复
                    thinkingMsg.remove();
                    addMessage(response, 'ai');
                    
                } catch (error) {
                    console.error('AI助读失败:', error);
                    thinkingMsg.remove();
                    addMessage('抱歉，我暂时无法回答这个问题。请检查网络连接或稍后重试。', 'ai');
                }
            }
            
            function addMessage(content, sender, isThinking = false) {
                const messageDiv = document.createElement('div');
                
                if (sender === 'user') {
                    messageDiv.className = 'flex justify-end';
                    messageDiv.innerHTML = `
                        <div class="bg-primary text-white rounded-lg p-3 max-w-xs">
                            <p class="text-sm">${content}</p>
                        </div>
                    `;
                } else {
                    messageDiv.className = 'flex justify-start';
                    const bgClass = isThinking ? 'bg-gray-100' : 'bg-blue-50';
                    messageDiv.innerHTML = `
                        <div class="${bgClass} rounded-lg p-3 max-w-xs">
                            <p class="text-sm text-text-primary">${content}</p>
                        </div>
                    `;
                }
                
                aiChatMessages.appendChild(messageDiv);
                aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
                
                return messageDiv;
            }
        });
    </script>

    <!-- AI助读按钮 -->
    <div id="ai-assistant-btn" class="fixed bottom-8 right-8 z-40">
        <button class="w-12 h-12 bg-red-500 text-white rounded-full shadow-lg hover:bg-red-600 transition-all flex items-center justify-center">
            <span class="font-bold text-sm">AI</span>
        </button>
    </div>

    <!-- AI助读对话框 -->
    <div id="ai-assistant-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="absolute right-0 top-0 bottom-0 w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300">
            <div class="p-4 border-b border-border-light">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold text-sm">AI</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-text-primary">小樟同学</h3>
                            <p class="text-xs text-text-secondary">AI助读助手</p>
                        </div>
                    </div>
                    <button id="ai-assistant-close" class="p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
            </div>
            
            <div class="h-full flex flex-col">
                <!-- 对话内容区域 -->
                <div id="ai-chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                    <div class="bg-blue-50 rounded-lg p-3 max-w-xs">
                        <p class="text-sm text-text-primary">你好！我是小樟同学，有什么关于小说阅读的问题都可以问我哦~</p>
                    </div>
                </div>
                
                <!-- 输入区域 -->
                <div class="p-4 border-t border-border-light pb-8">
                    <div class="flex space-x-2">
                        <input type="text" id="ai-chat-input" placeholder="输入你的问题..." 
                               class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:border-primary">
                        <button id="ai-chat-send" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="mt-2 flex flex-wrap gap-1">
                        <button class="quick-question-btn text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">解释这段情节</button>
                        <button class="quick-question-btn text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">人物关系</button>
                        <button class="quick-question-btn text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">写作手法</button>
                        <button class="quick-question-btn text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200">后续预测</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 版权信息 -->
    <footer class="bg-white border-t border-border-light py-6">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex flex-col items-center space-y-4">
                <div class="flex items-center space-x-3">
                    <img src="logo.png" alt="小说智阅坊" class="w-8 h-8">
                    <span class="text-sm text-text-secondary">上海大学 25121385 于承樟</span>
                </div>
                <p class="text-xs text-text-secondary">© 2025 小说智阅坊 - 智能阅读平台</p>
            </div>
        </div>
    </footer>

    <!-- 自定义剧情输入模态框 -->
    <div id="custom-input-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full transform transition-all">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">
                        <i class="fas fa-edit text-primary mr-2"></i>
                        自定义剧情走向
                    </h3>
                    <p class="text-sm text-text-secondary mb-4">
                        请输入你希望的故事发展方向，AI将根据你的想法生成后续剧情
                    </p>
                    <textarea 
                        id="custom-input-text" 
                        class="w-full h-32 p-3 border border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary focus:outline-none resize-none"
                        placeholder="例如：萧炎决定探索戒指的秘密，发现里面住着一位神秘强者..."
                    ></textarea>
                    <div class="flex space-x-3 mt-4">
                        <button 
                            id="custom-input-cancel" 
                            class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                            取消
                        </button>
                        <button 
                            id="custom-input-submit" 
                            class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                            生成剧情
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 自定义输入模态框功能
        const customInputModal = document.getElementById('custom-input-modal');
        const customInputText = document.getElementById('custom-input-text');
        const customInputCancel = document.getElementById('custom-input-cancel');
        const customInputSubmit = document.getElementById('custom-input-submit');

        // 获取自定义输入的函数
        function getCustomInput() {
            return new Promise((resolve) => {
                // 重置输入框
                customInputText.value = '';
                
                // 显示模态框
                customInputModal.classList.remove('hidden');
                
                // 聚焦输入框
                setTimeout(() => {
                    customInputText.focus();
                }, 100);
                
                // 取消按钮处理
                const handleCancel = () => {
                    customInputModal.classList.add('hidden');
                    resolve(null);
                };
                
                // 提交按钮处理
                const handleSubmit = () => {
                    const input = customInputText.value.trim();
                    if (input) {
                        customInputModal.classList.add('hidden');
                        resolve(input);
                    } else {
                        alert('请输入你的想法！');
                        customInputText.focus();
                    }
                };
                
                // 绑定事件（一次性使用）
                customInputCancel.onclick = handleCancel;
                customInputSubmit.onclick = handleSubmit;
                
                // 回车键提交
                const handleKeydown = (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        handleSubmit();
                    }
                };
                
                customInputText.addEventListener('keydown', handleKeydown);
                
                // 点击背景关闭
                const handleBackgroundClick = (e) => {
                    if (e.target === customInputModal) {
                        handleCancel();
                    }
                };
                
                customInputModal.addEventListener('click', handleBackgroundClick);
                
                // 清理函数
                const cleanup = () => {
                    customInputCancel.onclick = null;
                    customInputSubmit.onclick = null;
                    customInputText.removeEventListener('keydown', handleKeydown);
                    customInputModal.removeEventListener('click', handleBackgroundClick);
                };
                
                // 无论结果如何都清理事件
                const originalResolve = resolve;
                resolve = (value) => {
                    cleanup();
                    originalResolve(value);
                };
            });
        }
    </script>
</body>
</html>