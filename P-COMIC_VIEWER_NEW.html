<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四格漫画生成器 - 小说智阅坊</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .input-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
        }
        
        h2 {
            font-size: 1.6rem;
            margin-bottom: 15px;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            color: #2563eb;
        }
        
        textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            flex: 2;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            flex: 1;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            flex: 1;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .comic-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .comic-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .comic-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .comic-panel {
            background: #f8fafc;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .comic-panel:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .comic-image {
            width: 100%;
            min-height: 200px;
            max-height: 300px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 0.9rem;
            overflow: hidden;
        }
        
        .comic-image img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
        }
        
        .comic-content {
            padding: 15px;
        }
        
        .comic-number {
            font-size: 0.8rem;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }
        
        .comic-description {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #475569;
        }
        
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #2563eb;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            color: #dc2626;
        }
        
        .success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            color: #059669;
        }
        
        .status-info {
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #1e40af;
        }
        
        footer {
            background: #1e293b;
            color: white;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
        }
        
        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .footer-content img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }
        
        .footer-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-images"></i> 四格漫画生成器</h1>
            <p class="subtitle">将小说文本转换为生动的黑白简笔画漫画</p>
        </header>
        
        <div class="main-content">
            <div class="input-section">
                <h2><i class="fas fa-edit"></i> 输入小说文本</h2>
                <textarea id="novel-text" placeholder="请输入小说文本片段...例如：萧炎站在药铺门前，心中五味杂陈。三年了，自从修为倒退之后，他已经很久没有踏入这里..."></textarea>
                
                <div class="button-group">
                    <button id="generate-btn" class="btn-primary">
                        <i class="fas fa-magic"></i> 生成四格漫画
                    </button>
                    <button id="clear-btn" class="btn-secondary">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                    <button id="back-btn" class="btn-danger">
                        <i class="fas fa-arrow-left"></i> 返回
                    </button>
                </div>
                
                <div class="status-info">
                    <i class="fas fa-info-circle"></i> 
                    提示：输入小说文本后，AI会自动分析情节并生成四格黑白简笔画漫画
                </div>
            </div>
            
            <div class="comic-section">
                <h2><i class="fas fa-camera"></i> 四格漫画预览</h2>
                
                <div id="comic-display">
                    <div class="loading" style="display: none;" id="loading">
                        <i class="fas fa-spinner"></i>
                        <p>AI正在生成四格漫画，请稍候...</p>
                    </div>
                    
                    <div id="comic-grid" class="comic-grid">
                        <!-- 四格漫画将在这里动态生成 -->
                        <div class="comic-panel">
                            <div class="comic-image">
                                <i class="fas fa-image"></i> 等待生成第一格漫画
                            </div>
                            <div class="comic-content">
                                <div class="comic-number">第一格</div>
                                <div class="comic-description">漫画生成后将显示描述</div>
                            </div>
                        </div>
                        
                        <div class="comic-panel">
                            <div class="comic-image">
                                <i class="fas fa-image"></i> 等待生成第二格漫画
                            </div>
                            <div class="comic-content">
                                <div class="comic-number">第二格</div>
                                <div class="comic-description">漫画生成后将显示描述</div>
                            </div>
                        </div>
                        
                        <div class="comic-panel">
                            <div class="comic-image">
                                <i class="fas fa-image"></i> 等待生成第三格漫画
                            </div>
                            <div class="comic-content">
                                <div class="comic-number">第三格</div>
                                <div class="comic-description">漫画生成后将显示描述</div>
                            </div>
                        </div>
                        
                        <div class="comic-panel">
                            <div class="comic-image">
                                <i class="fas fa-image"></i> 等待生成第四格漫画
                            </div>
                            <div class="comic-content">
                                <div class="comic-number">第四格</div>
                                <div class="comic-description">漫画生成后将显示描述</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-content">
                <img src="logo.png" alt="小说智阅坊">
                <span>上海大学 25121385 于承樟</span>
            </div>
            <p class="footer-text">© 2025 小说智阅坊 - 智能阅读平台</p>
        </footer>
    </div>

    <!-- 引入API配置 -->
    <script src="api-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const generateBtn = document.getElementById('generate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const backBtn = document.getElementById('back-btn');
            const novelText = document.getElementById('novel-text');
            const comicDisplay = document.getElementById('comic-display');
            const comicGrid = document.getElementById('comic-grid');
            const loading = document.getElementById('loading');
            
            // 解析URL参数
            function getUrlParams() {
                const params = new URLSearchParams(window.location.search);
                return {
                    text: params.get('text') ? decodeURIComponent(params.get('text')) : '',
                    novel: params.get('novel') || ''
                };
            }
            
            // 自动填充文本
            const urlParams = getUrlParams();
            if (urlParams.text) {
                novelText.value = urlParams.text;
                // 自动开始生成漫画
                setTimeout(() => {
                    generateBtn.click();
                }, 500);
            }
            
            // 生成四格漫画
            generateBtn.addEventListener('click', async function() {
                const text = novelText.value.trim();
                
                if (!text) {
                    alert('请输入小说文本！');
                    return;
                }
                
                // 显示加载状态
                loading.style.display = 'flex';
                comicGrid.style.display = 'none';
                generateBtn.disabled = true;
                
                try {
                    await generateComicPanels(text);
                } catch (error) {
                    console.error('生成漫画失败:', error);
                    showError('漫画生成失败：' + error.message);
                } finally {
                    loading.style.display = 'none';
                    comicGrid.style.display = 'grid';
                    generateBtn.disabled = false;
                }
            });
            
            // 清空文本
            clearBtn.addEventListener('click', function() {
                novelText.value = '';
                resetComicPanels();
            });
            
            // 返回按钮
            backBtn.addEventListener('click', function() {
                if (confirm('确定要返回阅读器页面吗？')) {
                    window.location.href = 'P-READER.html';
                }
            });
            
            // 生成四格漫画
            async function generateComicPanels(sceneText) {
                // 在Netlify环境下，直接跳过服务器检查
                const isNetlify = window.location.hostname.includes('netlify.app');
                
                if (!isNetlify) {
                    // 本地环境：检查服务器状态
                    if (!await checkServerStatus()) {
                        throw new Error('火山方舟服务器未启动，请先运行 start_volcano_server.bat');
                    }
                }
                
                // 生成漫画描述
                const comicDescription = await generateComicDescription(sceneText);
                
                // 解析为四个面板
                const panels = parseComicDescription(comicDescription);
                
                // 生成漫画图像
                await generateComicImages(panels);
            }
            
            // 生成漫画描述
            async function generateComicDescription(sceneText) {
                try {
                    const prompt = `请为以下小说片段创作适合黑白简笔画风格的四格漫画描述：
${sceneText}

要求：
1. 适合黑白线条简笔画风格
2. 画面简洁明了，避免复杂细节
3. 每格漫画包含清晰的场景和人物动作
4. 适合添加简单的文字说明
5. 保持漫画的连贯性和趣味性

请为每一格漫画提供简洁的描述，用中文回答。格式如下：
第一格：[描述]
第二格：[描述]
第三格：[描述]
第四格：[描述]`;
                    
                    return await window.apiService.generateText(prompt, 500);
                } catch (error) {
                    console.error('生成漫画描述失败:', error);
                    // 返回默认描述
                    return `第一格：主角在场景中的初始状态
第二格：情节发展的关键时刻
第三格：冲突或转折的发生
第四格：结局或新的开始`;
                }
            }
            
            // 解析漫画描述
            function parseComicDescription(description) {
                const lines = description.split('\n').filter(line => line.trim());
                const panels = [];
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('第一格') || lines[i].includes('第1格')) {
                        panels.push(lines[i].replace(/^.*?：/, '').trim());
                    } else if (lines[i].includes('第二格') || lines[i].includes('第2格')) {
                        panels.push(lines[i].replace(/^.*?：/, '').trim());
                    } else if (lines[i].includes('第三格') || lines[i].includes('第3格')) {
                        panels.push(lines[i].replace(/^.*?：/, '').trim());
                    } else if (lines[i].includes('第四格') || lines[i].includes('第4格')) {
                        panels.push(lines[i].replace(/^.*?：/, '').trim());
                    }
                }
                
                // 如果解析失败，使用默认描述
                if (panels.length === 0) {
                    return [
                        '主角在场景中的初始状态',
                        '情节发展的关键时刻',
                        '冲突或转折的发生',
                        '结局或新的开始'
                    ];
                }
                
                return panels.slice(0, 4);
            }
            
            // 生成漫画图像
            async function generateComicImages(panels) {
                const comicPanels = document.querySelectorAll('.comic-panel');
                const isNetlify = window.location.hostname.includes('netlify.app');
                
                for (let i = 0; i < Math.min(panels.length, 4); i++) {
                    const panel = comicPanels[i];
                    const panelNumber = i + 1;
                    
                    // 更新描述
                    panel.querySelector('.comic-description').textContent = panels[i];
                    
                    // 显示生成中状态
                    panel.querySelector('.comic-image').innerHTML = `
                        <i class="fas fa-spinner fa-spin"></i> 生成第${panelNumber}格漫画中...
                    `;
                    
                    try {
                        let imageUrl;
                        
                        if (isNetlify) {
                            // Netlify环境：直接调用豆包API
                            imageUrl = await generateComicImageDirect(panels[i], panelNumber);
                        } else {
                            // 本地环境：使用API服务
                            imageUrl = await window.apiService.generateComicImage(panels[i], panelNumber);
                        }
                        
                        // 更新图像
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = `四格漫画第${panelNumber}格`;
                        img.onerror = function() {
                            this.style.display = 'none';
                            this.parentElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 图像加载失败';
                        };
                        panel.querySelector('.comic-image').innerHTML = '';
                        panel.querySelector('.comic-image').appendChild(img);
                        
                        // 添加成功样式
                        panel.style.border = '2px solid #10b981';
                        
                    } catch (error) {
                        console.error(`生成第${panelNumber}格漫画失败:`, error);
                        
                        // 在Netlify环境下，如果API调用失败，使用模拟图像
                        if (isNetlify) {
                            const mockImageUrl = `https://via.placeholder.com/400x300/4A90E2/FFFFFF?text=漫画${panelNumber}`;
                            const img = document.createElement('img');
                            img.src = mockImageUrl;
                            img.alt = `四格漫画第${panelNumber}格（模拟）`;
                            panel.querySelector('.comic-image').innerHTML = '';
                            panel.querySelector('.comic-image').appendChild(img);
                            panel.style.border = '2px solid #f59e0b';
                        } else {
                            panel.querySelector('.comic-image').innerHTML = `
                                <i class="fas fa-exclamation-triangle"></i> 生成失败
                            `;
                            panel.style.border = '2px solid #ef4444';
                        }
                    }
                    
                    // 添加延迟避免API限制
                    if (i < 3) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            
            // 直接调用豆包API生成漫画图像（Netlify环境专用）
            async function generateComicImageDirect(description, panelNumber) {
                const prompt = `请生成黑白简笔画风格的漫画图像，要求：
1. 黑白线条简笔画风格
2. 画面简洁明了，避免复杂细节
3. 适合四格漫画的构图
4. 根据以下描述创作：${description}

请生成适合黑白印刷的简笔画风格图像。`;
                
                const requestData = {
                    model: 'doubao-seedream-4-0-250828',
                    prompt: prompt,
                    size: '1024x1024',
                    n: 1,
                    response_format: 'url'
                };
                
                try {
                    // 尝试直接调用豆包API
                    const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/images/generations', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer bdc88b39-5c8d-45c4-b78d-fb71fbd0b534',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API调用失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data && data.data && data.data.length > 0) {
                        return data.data[0].url;
                    } else {
                        throw new Error('API返回数据格式错误');
                    }
                    
                } catch (error) {
                    console.error('直接调用豆包API失败:', error);
                    
                    // 如果直接调用失败，尝试通过Netlify函数
                    try {
                        const netlifyResponse = await fetch('/api/generate-comic-panel', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                panelDescription: description,
                                panelNumber: panelNumber
                            })
                        });
                        
                        if (netlifyResponse.ok) {
                            const netlifyData = await netlifyResponse.json();
                            if (netlifyData.success && netlifyData.data && netlifyData.data.imageUrl) {
                                return netlifyData.data.imageUrl;
                            }
                        }
                    } catch (netlifyError) {
                        console.error('Netlify函数调用失败:', netlifyError);
                    }
                    
                    // 如果所有方法都失败，抛出错误
                    throw error;
                }
            }
            
            // 重置漫画面板
            function resetComicPanels() {
                const comicPanels = document.querySelectorAll('.comic-panel');
                comicPanels.forEach((panel, index) => {
                    panel.querySelector('.comic-image').innerHTML = `
                        <i class="fas fa-image"></i> 等待生成第${index + 1}格漫画
                    `;
                    panel.querySelector('.comic-description').textContent = '漫画生成后将显示描述';
                    panel.style.border = 'none';
                });
            }
            
            // 检查服务器状态
            async function checkServerStatus() {
                try {
                    const response = await fetch('/api/health', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('服务器状态检查成功:', data);
                        return true;
                    } else {
                        console.warn('服务器响应异常:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.warn('服务器连接失败:', error);
                    // 在Netlify环境下，即使连接失败也继续尝试生成漫画
                    const isNetlify = window.location.hostname.includes('netlify.app');
                    return isNetlify; // Netlify环境下返回true，本地环境返回false
                }
            }
            
            // 显示错误信息
            function showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>错误：</strong> ${message}
                `;
                
                comicDisplay.insertBefore(errorDiv, comicGrid);
                
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }
            
            // 显示成功信息
            function showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'success';
                successDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>成功：</strong> ${message}
                `;
                
                comicDisplay.insertBefore(successDiv, comicGrid);
                
                setTimeout(() => {
                    successDiv.remove();
                }, 3000);
            }
        });
    </script>
</body>
</html>